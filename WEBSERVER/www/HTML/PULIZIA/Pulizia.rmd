---
title: "PULIZIA"
author: "Damiano Fumagalli"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(stringr)
knitr::opts_chunk$set(echo = TRUE)
source("../importData.R")
```

# INDICE {#indice}

-   [AMAZON](#amazon)

-   [DISNEY](#disney)

-   [GROSS](#gross)

-   [MOVIELENS](#movielens)

-   [NETFLIX](#netflix)

-   [SEQUELS](#sequels)

-   [TMDB](#tmdb)

-   [FONTE DATI](./Presentazione.html#fonte-dei-dati)

# [AMAZON](#indice) {#amazon}

```{r}
levels(factor(amazon$type))
```

-   siccome sono due i possibili valori, la colonna può essere sostituita con valori logici TRUE o FALSE

```{r}
# View(amazon)
spec(amazon)

amazon = amazon %>% filter(!is.na(type))  %>% select(-date_added,-description)
colnames(amazon)[7] = "Year"
colnames(amazon)[10] = "Genres"

# CREA UNA COLONNA "Movie" LOGICA 
amazon = amazon %>% mutate(Movie = (type=="Movie")) %>% select(-type)

head(amazon)
```

### SEPARAZIONE

```{r}
amazonMovies = amazon %>% filter(Movie == TRUE)
# ".{N}$" seleziona gli ultimi N caratteri della stringa
# viene rimosso " min" da ogni campo duration
amazonMovies = amazonMovies %>% mutate(duration = gsub(".{4}$","",duration)) %>% select(-Movie,-show_id)
head(amazonMovies)



amazonShows = amazon %>% filter(Movie == FALSE)
# In Seasons vengono lasciati solo i primi 2 caratteri
amazonShows = amazonShows %>% mutate(Seasons = substr(duration,1,2)) %>% select(-duration,-Movie,-show_id) %>% mutate(Seasons = gsub(" ","",Seasons))
# Se esiste un carattere " " viene rimosso
head(amazonShows)
```

### GENERI

```{r}
genres = vector(mode = "character")
for (i in 1:nrow(amazon)){
  gen = unlist(str_split(amazon$Genres[i],", "))
  # vengono selezionati solo i generi che NON sono presenti in genres
  gen = gen[!(gen %in% genres)]
  genres = append(genres, gen )
}
(amazGenres = levels(factor(genres)))
amazonGenres = data.frame(
  genreID = 1:length(amazGenres),
  genre = amazGenres
)
```

### RATING

```{r}

amazonMovieRatings = levels(factor(amazonMovies$rating))
amazonTVRatings = levels(factor(amazonShows$rating))

amazonRatTypes = levels(factor(amazon$rating))
(amazonRatingTypes = data.frame(
  ratingID = 1:length(amazonRatTypes),
  rating = amazonRatTypes,
  Movie = amazonRatTypes %in% amazonMovieRatings
))
# la colonna Movie indicherà se il rating type appartiene alla categoria Film o TV Show


```

### COUNTRIES

```{r}
countries = vector(mode = "character")
for (i in 1:nrow(amazon)){
  countr = unlist(str_split(amazon$country[i],", "))
  countr = countr[!(countr %in% countries)]
  countries = append(countries,countr)
}
amazCountr = levels(factor(countries))
(amazonCountries = data.frame(
  countryID = 1:length(amazCountr),
  country = amazCountr
))
```

### DIRECTORS

```{r}
directors = vector(mode = "character")
for (i in 1:nrow(amazon)){
  dir = unlist(str_split(amazon$director[i],", "))
  dir = dir[!(dir %in% directors)]
  directors = append(directors,dir)
}
dirs = levels(factor(directors))
amazonDirectors = data.frame(
  dirID = 1:length(dirs),
  director = dirs
)
```

# [DISNEY](#indice) {#disney}

-   Descrizione e Data di Aggiunta non necessarie

```{r}
# View(disney)
disney = disney %>% select(-description,-date_added)
colnames(disney)[7] = "Year"
colnames(disney)[10] = "Genres"
head(disney)
```

```{r}
levels(factor(disney$type))
```

-   siccome sono due i possibili valori, la colonna può essere sostituita con valori logici TRUE o FALSE

```{r}
# MODIFICA TYPE
disney = disney %>% mutate(Movie = (type == "Movie")) %>% select(-type)
head(disney)
```

### SEPARAZIONE

-   Il campo Duration va modificato per Film e Serie TV diversamente

```{r}
disneyMovies = disney %>% filter(Movie == TRUE)
# MODIFICARE IL CAMPO DURATION
# rimuove " min" alla fine di ogni campo
disneyMovies = disneyMovies %>% mutate(duration = gsub(".{4}$","",duration)) 
head(disneyMovies)



disneyShows = disney %>% filter(Movie == FALSE)
# rimuove tutti i caratteri superflui in modo da salvare solo il numero
disneyShows = disneyShows %>% mutate(Seasons = substr(duration,1,2)) %>% select(-duration) %>% mutate(Seasons = gsub(" ","",Seasons))
head(disneyShows)

```

### GENERI

```{r}
genres = vector(mode = "character")
for (i in 1:nrow(disney)){
  gen = unlist(str_split(disney$Genres[i],", "))
  gen = gen[!(gen %in% genres)]
  genres = append(genres,gen  )
}
disGenre  = levels(factor(genres))
(disneyGenreTable = data.frame(
  genreID = 1:length(disGenre),
  genre = disGenre
))
```

### RATING

```{r}
disRats = levels(factor(disney$rating))
(disneyRatingTypes = data.frame(
  ratingID = 1:length(disRats),
  rating = disRats
))
```

### COUNTRIES

```{r}
countries = vector(mode = "character")
for (i in 1:nrow(disney)){
  countr = unlist(str_split(disney$country[i],", "))
  countr = countr[!(countr %in% countries)]
  countries = append(countries,countr  )
}
disCount = levels(factor(countries))
(disneyCountries = data.frame(
  countryID = 1:length(disCount),
  country = disCount
))
```

# [GROSS](#indice) {#gross}

-   Release_Date e Movie Info non sono necessari

```{r}
# View(HighestGrossers)
# spec(HighestGrossers)
HighestGrossers = HighestGrossers %>% filter(!is.na(`Movie Runtime`)) %>% select(-...1,-`Movie Info`,-`Release Date`)
```

### SEPARAZIONE

```{r}
# SEPARAZIONE TITLE YEAR
HighestGrossers = separate(HighestGrossers,Title,into = c("Title","Year"),sep = -5) %>% mutate(Title = gsub('.{2}$', '', Title)) %>% mutate(Year = gsub('.{1}$', '', Year))
```

-   Convertire la notazione da "x hr y min" a "x min"

```{r}
# DURATION
HighestGrossers = HighestGrossers  %>% separate(`Movie Runtime`,into = c("Hour","Min"),sep = " hr ")
# toglie " min" da ogni campo
HighestGrossers = HighestGrossers %>% mutate(Min = gsub(" min","",Min))

# HOUR e MIN SONO CHARACTER, PERCIò BISOGNA CONVERTIRE IN INTERO
HighestGrossers = HighestGrossers %>% mutate("Duration (mins)" = ifelse(!is.na(Min), strtoi( Min)+(strtoi(Hour)*60),strtoi(Hour)*60 )) %>% select(-Min, -Hour)


head(HighestGrossers)
```

### GENERI

-   è necessario rimuovere le "[" "]" dal blocco note, al fine di rendere leggibile il contenuto del campo Genre

```{r}

HighestGrossers = HighestGrossers %>% mutate(Genre = gsub("'","",Genre))


genres = vector(mode = "character")
for (i in 1:nrow(HighestGrossers)){
  gen = unlist(str_split(HighestGrossers$Genre[i],", "))
  gen = gen[!(gen %in% genres)]
  genres = append(genres, gen )
}
grossGenre = levels(factor(genres))
(grossGenreTable = data.frame(
  genreID = 1:length(grossGenre),
  genre = grossGenre
))
```

### RATING

```{r}
levels(factor(HighestGrossers$License))
```

### DISTRIBUTORS

```{r}
grossDistr = levels(factor(HighestGrossers$Distributor))
(grossDistributors = data.frame(
  distrID = 1:length(grossDistr),
  distributor = grossDistr
))
```

# [MOVIELENS](#indice) {#movielens}

-   modificare i separatori da "::" a ";" direttamente dal blocco note

## MOVIES

-   Separazione Titolo e Anno

```{r}
# rimuove l'ultimo carattere
#View(movies)


movies = separate(movies,Title,into = c("Title","Year"),sep = -5)
# rimuove gli ultimi due caratteri
movies$Title = gsub('.{2}$', '', movies$Title)

movies$Year = gsub('.{1}$', '', movies$Year)
```

-   errori nel campo Title

```{r}
# alcuni film possiedono una notazione errata
head(movies %>% filter(grepl(",",Title)) %>% select(Title))
# ciclo per risolvere la notazione
for (i in 1:nrow(movies)){
  if (grepl(",",movies$Title[i])){
    arr = unlist(str_split(movies$Title[i],", "))
    movies$Title[i] = paste(arr[2],arr[1])
  }
}

head(movies)
```

### GENERI

```{r}
# View(movies)
arr = vector(mode = "character")
for (i in 1:nrow(movies)){
  gen = unlist(strsplit(movies$Genres[i],"|",fixed = TRUE))
  gen = gen[!(gen %in% arr)]
  arr = append(arr, gen )
}
(movieLensGenreTable = data.frame(
 genreID = 1:length(levels(factor(arr))),
 genre = levels(factor(arr))
))






```

## RATINGS

```{r}
spec(ratings)
ratings = ratings %>% filter(!is.na(movieID) && !is.na(Rating)) %>% select(-Timestamp) 
head(ratings)
(votiAmmessi = levels(factor(ratings$Rating)))
```

## USERS

```{r}
spec(users)
colnames(users)[1] = "userID"
colnames(users)[5] = "zip"   # affinche coincida con uszips
users = users %>% filter(!is.na(Gender) && !is.na(Age)  && !is.na(zip))
```

```{r}
levels(factor(users$Gender))
```

-   siccome sono due i possibili valori, la colonna può essere sostituita con valori logici TRUE o FALSE

```{r}
# MODIFICA
users = users %>% mutate(Male = (Gender == "M")) %>% select(-Gender)
head(users)
```

```{r}
(workTable = data.frame(
  workID = 0:20,
  workType = c("other","academic/educator","artist","clerical/admin","college/grad student","customer service","doctor/health care","executive/managerial","farmer","homemaker","K-12 student","lawyer","programmer","retired","sales/marketing","scientist","self-employed","technician/engineer","tradesman/craftsman","unemployed","writer")
))


(ageTable = data.frame(
  ageID = levels(factor(users$Age)),
  age = c("Under 18","18-24","25-34","35-44","45-49","50-55","Over 56")
))
```

# [NETFLIX](#indice) {#netflix}

-   Descrizione e Data di Aggiunta non necessarie

```{r}
# View(netflix)
spec(netflix)
netflix = netflix %>% select(-date_added,-description)
colnames(netflix)[7] = "Year"
colnames(netflix)[10] = "Genres"
```

-   siccome sono due i possibili valori, la colonna può essere sostituita con valori logici TRUE o FALSE

```{r}
levels(factor(netflix$type))
```

```{r}
# MODIFICA TYPE
netflix = netflix %>% mutate(Movie = (type == "Movie")) %>% select(-type)
```

### SEPARAZIONE

```{r}
netflixMovies = netflix %>% filter(Movie == TRUE)
# MODIFICA AL CAMPO DURATION
netflixMovies = netflixMovies %>% mutate(duration = gsub(" min","",duration))


netflixShows = netflix %>% filter(Movie == FALSE)
# DURATION TO SEASONS
netflixShows %>% mutate(Seasons = substr(duration,1,2)) %>% mutate(Seasons = gsub(" ","",Seasons)) %>% select(-duration)

```

### GENERI

```{r}
genres = vector(mode = "character")
for (i in 1:nrow(netflix)){
  gen = unlist(str_split(netflix$Genres[i],", "))
  gen = gen[!(gen %in% genres)]
  genres = append(genres, gen )
}
netGenr = levels(factor(genres))
(netflixGenres = data.frame(
  genreID = 1:length(netGenr),
  genre = netGenr
))
```

### RATING

```{r}
netRat = levels(factor(netflix$rating))
(netflixRatingTypes = data.frame(
  ratingID = 1:length(netRat),
  rating = netRat
))
```

### COUNTRIES

```{r}
countries = vector(mode = "character")
for (i in 1:nrow(netflix)){
  countr = unlist(str_split(netflix$country[i],", "))
  countr = countr[!(countr %in% countries)]
  countries = append(countries, countr )
}
netCount = levels(factor(countries))
(netflixCountries = data.frame(
  countryID = 1:length(netCount),
  country = netCount
))
```

# [SEQUELS](#indice) {#sequels}

```{r}
# View(sequels)



if (all(is.na(sequels$Description))){
  print("la tabella possiede una collona Description completamente vuota, di conseguenza è possibile rimuoverla")
}

# CREATED E MODIFIED NON CI INTERESSANO NELLA NOSTRA RICERCA
sequels = sequels %>% select(-Description,-Created,-Modified,-`Release Date`,-Const,-URL)

colnames(sequels)

# FILM CON VOTAZIONE NON VALIDA
head( sequels %>% filter(is.na(`IMDb Rating`)))

# PER RIMUOVERE DECOMMENTARE IL SEGUENTE CODICE
# sequels = sequels %>% filter(!is.na(`IMDb Rating`))


# RUNTIME NON VALIDO
head(sequels %>% filter(is.na(`Runtime (mins)`)))

# PER RIMUOVERE DECOMMENTARE IL SEGUENTE CODICE
# sequels = sequels %>% filter(!is.na(`Runtime (mins)`))


# ANNO NON VALIDO
sequels %>% filter(is.na(Year))
# PER RIMUOVERE DECOMMENTARE IL SEGUENTE CODICE
# sequels = sequels %>% sequels %>% filter(!is.na(Year))


# View(sequels)
```

### GENERI

```{r}
genres = vector(mode = "character")
for (i in 1:nrow(sequels)){
  gen = unlist(str_split(sequels$Genres[i],", "))
  gen = gen[!(gen %in% genres)]
  genres = append(genres, gen )
}
# LISTA CON TUTTI I GENERI
(sequelsGenreTable = data.frame(
  genreID = 1:length(levels(factor(genres))),
  genre = levels(factor(genres))
))
```

### TITLE TYPES

```{r}
(titleTypes = levels(factor(sequels$`Title Type`)))
# SEPARAZIONE
sequelMovies = sequels %>% filter(`Title Type`==titleTypes[1])
sequelTVEpisodes = sequels %>% filter(`Title Type`==titleTypes[2])
sequelTVMovies = sequels %>% filter(`Title Type`==titleTypes[3])
sequelTVShorts = sequels %>% filter(`Title Type`==titleTypes[4])
sequelVideos = sequels %>% filter(`Title Type`==titleTypes[5])



```

# [TMDB](#indice) {#tmdb}

```{r}
# View(tmdb)
spec(tmdb)
tmdb = tmdb %>% select(-original_language,-overview,-...1) %>% mutate(Year = format(release_date,"%Y")) %>% select(-release_date)
# MODIFICA LA DATA IN FORMATO SOLO ANNO
head(tmdb)

```

# [AGGIORNAMENTO](#indice)

I datasets sono stati riformati togliendo eventuali dati inutili alla ricerca.

### AMAZON

```{r}
filePath = "../../CLEAN_DATA/"

amazonPath = "AMAZON/"
write_csv(amazon,paste(filePath,amazonPath,"amazon.csv",sep="") )
write_csv(amazonMovies,paste(filePath,amazonPath,"amazonMovies.csv",sep="") )
write_csv(amazonShows,paste(filePath,amazonPath,"amazonShows.csv",sep="") )
write_csv(amazonGenres,paste(filePath,amazonPath,"amazonGenres.csv",sep="") )
write_csv(amazonRatingTypes,paste(filePath,amazonPath,"amazonRatingTypes.csv",sep="") )
write_csv(amazonCountries,paste(filePath,amazonPath,"amazonCountries.csv",sep="") )
write_csv(amazonDirectors,paste(filePath,amazonPath,"amazonDirectors.csv",sep="") )

```

### DISNEY

```{r}

disneyPath = "DISNEY/"
write_csv(disney,paste(filePath,disneyPath,"disney.csv",sep="") )
write_csv(disneyMovies,paste(filePath,disneyPath,"disneyMovies.csv",sep="") )
write_csv(disneyShows,paste(filePath,disneyPath,"disneyShows.csv",sep="") )
write_csv(disneyGenreTable,paste(filePath,disneyPath,"disneyGenreTable.csv",sep="") )
write_csv(disneyRatingTypes,paste(filePath,disneyPath,"disneyRatingTypes.csv",sep="") )
write_csv(disneyCountries,paste(filePath,disneyPath,"disneyCountries.csv",sep="") )
```

### HIGH GROSS

```{r}
grossPath = "GROSS/"
write_csv(HighestGrossers,paste(filePath,grossPath,"gross.csv",sep="") )
write_csv(grossGenreTable,paste(filePath,grossPath,"grossGenreTable.csv",sep="") )
write_csv(grossDistributors,paste(filePath,grossPath,"grossDistributors.csv",sep="") )

```

### MOVIELENS

```{r}
movielensPath = "MOVIELENS/"
write_csv(movies,paste(filePath,movielensPath,"movies.csv",sep="") )
write_csv(ratings,paste(filePath,movielensPath,"ratings.csv",sep="") )
write_csv(users,paste(filePath,movielensPath,"users.csv",sep="") )
write_csv(workTable,paste(filePath,movielensPath,"workTable.csv",sep="") )
write_csv(ageTable,paste(filePath,movielensPath,"ageTable.csv",sep="") )
write_csv(movieLensGenreTable,paste(filePath,movielensPath,"movieLensGenreTable.csv",sep="") )
```

### NETFLIX

```{r}
netflixPath = "NETFLIX/"
write_csv(netflix,paste(filePath,netflixPath,"netflix.csv",sep="") )
write_csv(netflixMovies,paste(filePath,netflixPath,"netflixMovies.csv",sep="") )
write_csv(netflixShows,paste(filePath,netflixPath,"netflixShows.csv",sep="") )
write_csv(netflixGenres,paste(filePath,netflixPath,"netflixGenres.csv",sep="") )
write_csv(netflixRatingTypes,paste(filePath,netflixPath,"netflixRatingTypes.csv",sep="") )
write_csv(netflixCountries,paste(filePath,netflixPath,"netflixCountries.csv",sep="") )

```

### SEQUELS

```{r}
sequelPath = "SEQUELS/"
write_csv(sequels,paste(filePath,sequelPath,"sequels.csv",sep="") )
write_csv(sequelsGenreTable,paste(filePath,sequelPath,"sequelsGenreTable.csv",sep="") )


write_csv(sequelMovies,paste(filePath,sequelPath,"sequelMovies.csv",sep="") )
write_csv(sequelTVEpisodes,paste(filePath,sequelPath,"sequelTVEpisodes.csv",sep="") )
write_csv(sequelTVMovies,paste(filePath,sequelPath,"sequelTVMovies.csv",sep="") )
write_csv(sequelTVShorts,paste(filePath,sequelPath,"sequelTVShorts.csv",sep="") )
write_csv(sequelVideos,paste(filePath,sequelPath,"sequelVideos.csv",sep="") )

```

### TMDB

```{r}

write_csv(tmdb,paste(filePath,"TMDB/","tmdb.csv",sep="") )

```
