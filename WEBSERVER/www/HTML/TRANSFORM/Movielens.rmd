---
title: "MOVIELENS"
author: "Damiano Fumagalli"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
# source("../../../R/cleanedData.R")
library(readr)
library(dplyr)
library(usmap)
library(ggplot2)
```

# INDICE

-   IMPORT DATA
-   RATING - OCCUPATION
-   MAPS

# IMPORT

```{r}
source("../IMPORT/dataScript/movielensData.r")
# DATASETS = movies, ratings, users, uszips, workTable, ageTable, MLGenres
```

# RATING PER OCCUPATION

```{r}



genreOcc = function(occID){

  mov = left_join(left_join(users %>% filter(Occupation == occID),ratings, by = "userID"),movies,by = "movieID") %>% filter(Rating>=4) # filtra i film che hanno un voto >= 4
  head(mov)
  prec = 0
  gen = ""
  for (i in 1:length(MLGenres$genre)){
     
    a = nrow(mov  %>% filter(grepl(MLGenres$genre[i],Genres)))
    if (a > prec) {
      prec = a
      gen = MLGenres$genre[i]
    }
  }
  return(gen)
}

# stampa la workTable
workTable


# genera un numero casuale tra [1:nrow(workTable)]
(id = floor( runif(1) * nrow(workTable))+1)
(randomWork = workTable$workType[id])
print(paste("Genere preferito da ",randomWork,": ",genreOcc(id),sep=""))






```

# USER-LOCATIONS {#userLocation}

-   Creare una tabella con ogni votazione associata al zipcode dell'utente

```{r}

meanUserRatings = ratings %>% group_by(userID) %>% summarise(numOfRatings = n(),MeanRating = mean(Rating))
head(meanUserRatings)

meanUserRatings = left_join(meanUserRatings,users,by="userID")
head(meanUserRatings)


# aggiungere info geografiche per creare la mappa
prova = left_join(meanUserRatings,uszips,by="zip") %>% select(MeanRating,zip,lat,lng,county_fips)
colnames(prova)[5] = "fips"
head(prova)


plot_usmap(data = prova, values = "MeanRating") +  scale_fill_continuous( low = "red", high = "green", name = "Mean Rating", label = scales::comma ) + theme(legend.position = "right")


```

# GGPLOT

```{r}



zipFreq = users %>% group_by(zip) %>% summarise(count = n()) %>% arrange(desc(count))
head(zipFreq)
# str(userZips)

countZips = left_join(zipFreq,uszips,by="zip") %>% select(zip,lng,lat,count,county_fips)
colnames(countZips)[5] = "fips"
#View(countZips)



ggplot(data=countZips, aes(x=lng, y=lat, fill=fips)) + 
  geom_polygon(data = countZips, color = "red") + 
  guides(fill=FALSE) + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  ggtitle('U.S. Map with States') + 
  coord_fixed(1.3)

```

# GROUPING

```{r}



plot_usmap(data = countZips, values = "count") +  scale_fill_continuous( low = "red", high = "green", name = "Number of Users", label = scales::comma ) + theme(legend.position = "right")
 


```
