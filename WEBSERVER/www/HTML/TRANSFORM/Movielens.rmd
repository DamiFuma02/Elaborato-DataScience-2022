---
title: "MOVIELENS"
author: "Damiano Fumagalli"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
# source("../../../R/cleanedData.R")
library(readr)
library(dplyr)
library(usmap)
library(ggplot2)
```

# INDICE

-   IMPORT DATA
-   RATING - OCCUPATION
-   MAPS

# IMPORT

```{r}
source("../IMPORT/dataScript/movielensData.r")
# DATASETS = movies, ratings, users, uszips, workTable, ageTable, MLGenres
```

# OCCUPATION {#occupation}

```{r}
workTable$workType
```

```{r}



genreOcc = function(occType){
  occID = workTable[workTable$workType == occType,]$workID
  userRatings = left_join(left_join(users %>% filter(occupation == occID),ratings, by = "userid"),movies,by = "movieid")
  prec = 0
  gen = ""
  for (i in 1:length(MLGenres$genre)){
    a = nrow(userRatings %>% filter(rating >= 4) %>% filter(grepl(MLGenres$genre[i],genres)) )
     
    if (a > prec) {
      prec = a
      gen = MLGenres$genre[i]
    }
  }
  return(gen)
}

data.frame(
  workType = workTable$workType,
  favGen = unlist(lapply(workTable$workType, genreOcc))
)


```

# USER-LOCATIONS {#userLocation}

```{r}
# choices = c(showMap, choiceParam)
usersMap = function(choices,param){  
  if (param  == "O"){
    occID = workTable[workTable$workType == choices[2],]$workID
    dati = left_join(users %>% filter(occupation == occID), ratings, by = "userid" ) %>% group_by(userid) %>% summarise(MeanRating = mean(rating), zip = levels(factor(zip))) %>% group_by(zip) %>% summarise(userCount = n())
    dati = left_join(dati,uszips  ,by="zip") 
    dati = dati %>% filter(!is.na(lat))
    plot = plot_usmap(data = dati,values = "userCount",labels = (choices[1] == "YES") , label_color = "white")  +  scale_fill_continuous( low = "red", high = "green", name = paste(choices[2],"users count"), label = scales::comma ) + theme(legend.position = "right")
    return(plot)
  } else {
    movieGenreID = (movies %>% filter(grepl(choices[2],genres)))$movieid
    meanUserRatings = ratings %>% filter(movieid %in% movieGenreID)  %>% group_by(userid) %>% summarise(MeanRating = mean(rating))
    head(meanUserRatings)
    
    meanUserRatings = left_join(meanUserRatings,users %>% select(userid,zip),by="userid")
    head(meanUserRatings)
    
    meanUserRatings = meanUserRatings %>% group_by(zip) %>% summarise(rating = mean(MeanRating))
    head(meanUserRatings)
    
  
    meanUserRatings = left_join(meanUserRatings,uszips ,by="zip") %>% select(rating,zip,lat,lng,fips)
    
    meanUserRatings = meanUserRatings %>% filter(!is.na(lat))
    plot = plot_usmap(data = meanUserRatings, values = "rating",labels = (choices[1] == "YES"), label_color = "white")  +  scale_fill_continuous( low = "red", high = "green", name = paste("User Rating for",choices[2],"movies",sep=" "), label = scales::comma ) + theme(legend.position = "right")
    
    return(plot)
  }
  
  
  
  
  
}
```

-   Creare una tabella con ogni votazione associata al zipcode dell'utente

```{r}
(param = ifelse(  ((floor(runif(1)*2)) == 0),"O","G"))
if (param == "O"){
  choices = c(FALSE,workTable$workType[floor(runif(1)*length(workTable$workType))+1])
} else {
  choices = c(FALSE,MLGenres$genre[floor(runif(1)*length(MLGenres$genre))+1])
}
print(paste("Chosen Param:",choices[2],sep=" "))

usersMap(choices,param)

```

# GGPLOT

```{r}



zipFreq = users %>% group_by(zip) %>% summarise(count = n()) %>% arrange(desc(count))
head(zipFreq)
# str(userZips)

countZips = left_join(zipFreq,uszips,by="zip") %>% select(zip,lng,lat,count,fips)
#View(countZips)



ggplot(data=countZips, aes(x=lng, y=lat, fill=fips)) + 
  geom_polygon(data = countZips, color = "red") + 
  guides(fill=FALSE) + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  ggtitle('U.S. Map with States') + 
  coord_fixed(1.3)

```

# GROUPING

```{r}



plot_usmap(data = countZips, values = "count") +  scale_fill_continuous( low = "red", high = "green", name = "Number of Users", label = scales::comma ) + theme(legend.position = "right")
 


```
