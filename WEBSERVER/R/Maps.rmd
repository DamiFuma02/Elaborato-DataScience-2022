---
title: "MAPS"
author: "Damiano Fumagalli"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries}
library(ggplot2)
library(tidyverse)
library(readr)
```


```{r import}
movies <- read_csv("MOVIELENS/movies.csv")
View(movies)

ratings <- read_csv("MOVIELENS/ratings.csv")
View(ratings)

users <- read_csv("MOVIELENS/users.csv")
View(users)

uszips <- read_csv("MOVIELENS/zipcodes/uszips.csv")
View(uszips)

```


* CREAZIONE DATASET MAPDATA CON I DATI GEOGRAFICI RELATIVI A TUTTO IL MONDO
* UNIONE DEL DATASET USERS CON IL MAPDATA CON CHIAVE = ZIPCODE
```{r tidy}
mapdata = map_data("world")
View(mapdata)
# MAPPA DI TUTTO IL MONDO
ggplot(mapdata, aes(x=long,y=lat))  + geom_point(size = 0.1)

usermapped = left_join(users,ratings, by = "userId") %>% select(-timestamp)
head(usermapped)
```

> CORRISPONDENZA TRA ZIP DEL USERMAPPED E ZIP DEL USZIPS

* USZIPS contiene i dati relativi alla posizione geografica (latitudine e longitudine) dei vari zipcode presenti nel territorio degli USA


```{r tiding}
mapdata1 = left_join(usermapped,uszips,by="zip") %>% select(userId,zip,rating) %>% left_join(uszips, by = "zip") %>% select(lng,lat,userId,county_fips, rating)
head(mapdata1)
# il nome è stato impostato affinchè ggplot riconosca il parametro fips
colnames(mapdata1)[4] = "fips"



# ggplot(mapdata1, aes(x=lng, y=lat)) +  geom_polygon(aes(fill=population))
```


# RATING MAPS
```{r}
library(usmap)
library(ggplot2)

mapdata1 = mapdata1 %>% filter(!is.na(rating))
colnames(mapdata1)


plot_usmap(data = mapdata1, values = "rating", color = "black") +  scale_fill_continuous(low="white",high="red" ,name = "Ratings") +  theme(legend.position = "right")
```
# USERID COUNT

```{r}
countUsers = mapdata1 %>% group_by(userId) %>% summarise(count = n())  %>% arrange(desc(count))

nrow(mapdata1 %>% filter(userId == 668)) == unlist(countUsers %>% filter(userId == 668) %>% select(count))

ggplot(countUsers,aes(x=userId,y=count)) + geom_point(size = 0.1)

countUsers %>% filter(count > 1)
```

# GGPLOT MAPPING

> GGPLOT2::MAP_DATA() crea un datasets contenente informazioni geospaziali del USA

```{r}
# USA DATA LOCALIZATION
usa = map_data("county") %>% select(lng = long, lat, group, id=region)
(usa_IDs = levels(factor(usa$id)))
usaID_DF = data.frame(id = usa_IDs, n = 1:length(usa_IDs))
head(usaID_DF)
# USZIPS DATASETS
colnames(uszips)[6] = "id"
uszips$id = tolower(uszips$id)
head(uszips)
(uszips_IDs = levels(factor(uszips$id)))
uszipsID_DF = data.frame(id = uszips_IDs, n = 1:length(uszips_IDs))
head(uszipsID_DF)
# CONTIENE GLI ID DELE REGIONI NEI DUE DATASETS
statesIDs = left_join(uszipsID_DF,usaID_DF, by = "id")
head(statesIDs)




head(left_join(usa,uszips,by="id"))

ggplot(usa, aes(lng, lat, group = group)) +
  geom_polygon(fill = "white", colour = "blue") + 
  coord_quickmap()
```


